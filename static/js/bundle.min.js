// Bundle optimizado para Natural Be - v2026-01-13
(function(){
'use strict';

// Variables globales críticas
window.NB_VERSION = "2026-01-13";
window.NB_DATA_VERSION = window.NB_VERSION;
window.ALL_PRODUCTS = [];
window.PRODUCTS = [];
window.PRODUCTS_BY_ID = {};
window.PRODUCTS_BY_SLUG = {};
window.NB_CATALOG_ERROR = false;
window.NB_CATALOG_SOURCE = '';

// Funciones utilitarias críticas
function escapeHtml(value) {
  return String(value || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function sanitizeUrl(value) {
  const raw = String(value || '');
  return /^\s*javascript:/i.test(raw) ? '#' : raw;
}

function normalizeText(value) {
  return String(value || '')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function debounce(fn, wait = 200) {
  let timer = null;
  return (...args) => {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => fn(...args), wait);
  };
}

// Función de búsqueda optimizada
function matchesQuery(product, query) {
  if (!query) return true;
  
  const normalizedQuery = normalizeText(query);
  
  if (normalizedQuery.split(' ').length === 1) {
    const searchFields = [
      product.nombre,
      product.marca,
      product.categoria,
      product.subcategoria,
      product.descripcion_corta,
      ...(product.tags || [])
    ];
    
    return searchFields.some(field => {
      const normalizedField = normalizeText(field);
      return normalizedField.includes(normalizedQuery);
    });
  }
  
  const searchTerms = normalizedQuery.split(' ').filter(term => term.length > 1);
  if (searchTerms.length === 0) return true;
  
  const searchFields = [
    { field: product.nombre, weight: 3 },
    { field: product.marca, weight: 2 },
    { field: product.categoria, weight: 3 },
    { field: product.subcategoria, weight: 2 },
    { field: product.descripcion_corta, weight: 1 },
    ...(product.tags || []).map(tag => ({ field: tag, weight: 2 }))
  ];
  
  let totalScore = 0;
  let maxPossibleScore = searchTerms.length * 3;
  
  for (const term of searchTerms) {
    let termScore = 0;
    
    for (const { field, weight } of searchFields) {
      const normalizedField = normalizeText(field);
      
      if (normalizedField.includes(term)) {
        termScore += weight;
        
        if (normalizedField.startsWith(term)) {
          termScore += weight * 0.5;
        }
        
        if (normalizedField === term) {
          termScore += weight * 2;
        }
      }
    }
    
    totalScore += termScore;
  }
  
  const threshold = maxPossibleScore * 0.3;
  return totalScore >= threshold;
}

// Carga de productos optimizada
async function loadProductsData(options = {}) {
  const version = window.NB_DATA_VERSION || '2026-01-13';
  const urls = [
    `./static/data/productos.json?v=${encodeURIComponent(version)}`,
    `/static/data/productos.json?v=${encodeURIComponent(version)}`,
    `https://naturalbe.com.co/static/data/productos.json?v=${encodeURIComponent(version)}`
  ];
  
  let lastError = null;
  for (const url of urls) {
    try {
      const response = await fetch(url, { cache: 'force-cache' });
      if (response.ok) {
        const data = await response.json();
        const products = Array.isArray(data) ? data : data.productos || [];
        
        window.ALL_PRODUCTS = products;
        window.PRODUCTS = products;
        window.PRODUCTS_BY_ID = {};
        window.PRODUCTS_BY_SLUG = {};
        
        products.forEach(product => {
          if (product.id) window.PRODUCTS_BY_ID[product.id] = product;
          if (product.slug) window.PRODUCTS_BY_SLUG[product.slug] = product;
        });
        
        window.NB_CATALOG_ERROR = false;
        window.NB_CATALOG_SOURCE = 'remote';
        return products;
      }
    } catch (err) {
      lastError = err;
    }
  }
  
  window.NB_CATALOG_ERROR = true;
  window.NB_CATALOG_SOURCE = 'fallback';
  window.ALL_PRODUCTS = [];
  window.PRODUCTS = [];
  return [];
}

// Sistema de carrito optimizado
let cart = JSON.parse(localStorage.getItem('nb-cart') || '[]');

function saveCart() {
  localStorage.setItem('nb-cart', JSON.stringify(cart));
  updateCartUI();
}

function addToCart(id, name, price, image) {
  const existingItem = cart.find(item => item.id === id);
  if (existingItem) {
    existingItem.quantity++;
  } else {
    cart.push({ id, name, price, image, quantity: 1 });
  }
  saveCart();
}

function removeFromCart(id) {
  cart = cart.filter(item => item.id !== id);
  saveCart();
}

function updateCartUI() {
  const cartCount = document.querySelector('.cart-badge');
  const cartTotal = document.getElementById('cartTotal');
  
  if (cartCount) {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
  }
  
  if (cartTotal) {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    cartTotal.textContent = new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      maximumFractionDigits: 0
    }).format(total);
  }
}

// Navegación y UI
function initSearchForms() {
  document.querySelectorAll('[data-search-form]').forEach(form => {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const input = form.querySelector('input[type="search"]');
      if (!input) return;
      const query = input.value.trim();
      if (!query) return;
      window.location.href = `category.html?q=${encodeURIComponent(query)}`;
    });
  });
}

function initMegaMenu() {
  const toggle = document.querySelector('[data-mega-toggle]');
  const menu = document.querySelector('[data-mega-menu]');
  if (!toggle || !menu) return;

  const setMenuState = (isOpen) => {
    menu.classList.toggle('is-open', isOpen);
    menu.hidden = !isOpen;
    menu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
  };

  const closeMenu = () => setMenuState(false);
  const openMenu = () => setMenuState(true);

  setMenuState(false);

  toggle.addEventListener('click', (e) => {
    e.stopPropagation();
    const willOpen = !menu.classList.contains('is-open');
    if (willOpen) openMenu(); else closeMenu();
  });

  document.addEventListener('click', (e) => {
    if (!menu.contains(e.target) && e.target !== toggle) {
      closeMenu();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && menu.classList.contains('is-open')) {
      closeMenu();
    }
  });
}

// Renderizado de productos
function buildProductCardHtml(product, eager = false) {
  const price = product.precio_oferta || product.precio || product.price || 0;
  const originalPrice = product.precio_oferta ? product.precio : null;
  const discount = product.discountPercent || (originalPrice ? Math.round((1 - price / originalPrice) * 100) : 0);
  const badge = product.badgeLabel || product.badge || "";
  const isNew = product.isNew ? "Nuevo" : "";
  const description = product.descripcion_corta || product.description || "";
  const url = sanitizeUrl(product.url || (product.slug ? `./product.html?slug=${encodeURIComponent(product.slug)}` : `/product.html`));
  const safeName = escapeHtml(product.nombre || product.name || "");
  const safeDesc = escapeHtml(description || "");
  const safeUrl = escapeHtml(url);
  const imgSrc = sanitizeUrl(product.imagen_principal || product.image || './static/img/placeholder.webp');
  const loading = eager ? 'eager' : 'lazy';
  
  return `
    <article class="product-card" itemscope itemtype="https://schema.org/Product">
      <a class="product-card__media" href="${safeUrl}">
        <img src="${imgSrc}" alt="${safeName}" loading="${loading}" decoding="async" width="320" height="240" itemprop="image">
      </a>
      <div class="product-card__body">
        <h3 class="product-card__title" itemprop="name">
          <a href="${safeUrl}">${safeName}</a>
        </h3>
        ${description ? `<p class="product-card__desc" itemprop="description">${safeDesc}</p>` : ""}
        <div class="product-card__price" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
          <meta itemprop="priceCurrency" content="COP">
          <meta itemprop="price" content="${price}">
          <span>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(price)}</span>
          ${originalPrice ? `<span class="price-old">${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(originalPrice)}</span>` : ""}
        </div>
        <div class="product-card__actions">
          <button class="btn-primary" type="button" onclick="addToCart('${product.id}', '${safeName}', ${price}, '${imgSrc}')">Agregar al carrito</button>
          <a class="btn-ghost" href="${safeUrl}">Ver detalle</a>
        </div>
      </div>
    </article>
  `;
}

function renderProductGrid(list, container) {
  if (!container) return;
  if (!list.length) {
    container.innerHTML = '<p class="section-subtitle">No hay productos disponibles por ahora.</p>';
    return;
  }
  
  container.innerHTML = list.map((product, index) => {
    const isAboveFold = index < 6;
    return buildProductCardHtml(product, isAboveFold);
  }).join('');
  
  // Actualizar contadores de carrito
  updateCartUI();
}

// Inicialización principal
document.addEventListener('DOMContentLoaded', () => {
  initSearchForms();
  initMegaMenu();
  updateCartUI();
  
  // Cargar productos si estamos en página de catálogo
  if (window.location.pathname.includes('category') || document.getElementById('plpGrid')) {
    loadProductsData().then(products => {
      if (document.getElementById('plpGrid')) {
        renderProductGrid(products, document.getElementById('plpGrid'));
      }
    });
  }
});

// Exponer funciones globalmente
window.addToCart = addToCart;
window.removeFromCart = removeFromCart;
window.loadProductsData = loadProductsData;
window.renderProductGrid = renderProductGrid;
window.escapeHtml = escapeHtml;
window.sanitizeUrl = sanitizeUrl;

})();
